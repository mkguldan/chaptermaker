name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ai-mvp-452812
  REGION: europe-west1
  SERVICE_NAME: chaptermaker
  ARTIFACT_REGISTRY: europe-west1-docker.pkg.dev

jobs:
  deploy:
    name: Build and Deploy Unified Service
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}

    - name: Build Unified Docker Image
      run: |
        docker build -t ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/chaptermaker-repo/app:${{ github.sha }} \
          -t ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/chaptermaker-repo/app:latest \
          -f Dockerfile .

    - name: Push Docker Image
      run: |
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/chaptermaker-repo/app:${{ github.sha }}
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/chaptermaker-repo/app:latest

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/chaptermaker-repo/app:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --set-env-vars "APP_ENV=production" \
          --set-env-vars "GCP_PROJECT_ID=${{ env.PROJECT_ID }}" \
          --set-env-vars "GCS_UPLOAD_BUCKET=chaptermaker-uploads-${{ env.PROJECT_ID }}" \
          --set-env-vars "GCS_OUTPUT_BUCKET=chaptermaker-outputs-${{ env.PROJECT_ID }}" \
          --set-env-vars "CLOUD_TASKS_QUEUE=video-processing" \
          --set-env-vars "CLOUD_TASKS_LOCATION=${{ env.REGION }}" \
          --set-secrets "OPENAI_API_KEY=OPENAI_API_KEY:latest" \
          --memory 2Gi \
          --cpu 2 \
          --timeout 900 \
          --concurrency 100 \
          --max-instances 10

    - name: Get Service URL
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --format 'value(status.url)')
        
        echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Service URL:" >> $GITHUB_STEP_SUMMARY
        echo "- **Application:** $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
        echo "- **API Documentation:** $SERVICE_URL/api/docs" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check:** $SERVICE_URL/health" >> $GITHUB_STEP_SUMMARY

  setup-cloud-storage:
    name: Setup Cloud Storage (Europe)
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Create GCS Buckets (if not exists)
      run: |
        # Create upload bucket in Europe
        gsutil mb -p ${{ env.PROJECT_ID }} -l ${{ env.REGION }} -c STANDARD gs://chaptermaker-uploads-${{ env.PROJECT_ID }} || echo "Upload bucket already exists"
        
        # Create output bucket in Europe
        gsutil mb -p ${{ env.PROJECT_ID }} -l ${{ env.REGION }} -c STANDARD gs://chaptermaker-outputs-${{ env.PROJECT_ID }} || echo "Output bucket already exists"
        
        # Set CORS on upload bucket
        echo '[{"origin": ["*"], "method": ["GET", "HEAD", "PUT", "POST", "DELETE"], "responseHeader": ["Content-Type"], "maxAgeSeconds": 3600}]' > cors-config.json
        gsutil cors set cors-config.json gs://chaptermaker-uploads-${{ env.PROJECT_ID }}
        gsutil cors set cors-config.json gs://chaptermaker-outputs-${{ env.PROJECT_ID }}
        rm cors-config.json
        
        # Set lifecycle rules to auto-delete old files
        echo '{"lifecycle": {"rule": [{"action": {"type": "Delete"}, "condition": {"age": 7}}]}}' > lifecycle-config.json
        gsutil lifecycle set lifecycle-config.json gs://chaptermaker-uploads-${{ env.PROJECT_ID }}
        rm lifecycle-config.json
